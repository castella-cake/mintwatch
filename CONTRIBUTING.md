# MintWatch の貢献ガイド
MintWatch はオープンソースであり、貢献を歓迎します。   
ここには、貢献をする際に役立つ情報などをまとめています。

なお、このドキュメントは全体的に仮段階に近いため、情報が不十分かもしれません。   
不明な点があれば、いつでも Issue 経由で質問してください。

PepperMint+ 用の CONTRIBUTING.md を少し編集したものです。   

## 各部名称
- Niconico-PepperMint+ は PepperMint+, PM+ と省略できます
- MintWatch は 内部名称として PMWatch (省略形として PMW)を使用します
- ダークモード/カラーパレット は ダークモード を使用します
- 特定のページに対するダークモード用スタイルは ダークモードサポート と呼びます
- Manifest V3, Manifest V2 は MV3, MV2 のように省略できます

## Issue を建てる
もちろん Issue は大歓迎です！   
バグ報告を行う場合は、以下の内容を最低限記載することを推奨します:
(今のところテンプレートを作るほどの余裕がありません…申し訳ないです)
- 期待される動作
- 実際の動作
- 再現手順
- 拡張機能のバージョン
- ブラウザに関する情報(ブラウザ名, バージョン)
- OS に関する情報(種類, バージョン)
また、Issueを建てる前に、それが他の拡張機能によって引き起こされたものではないかを確認してください。   
他にも、重複している Issue がないかどうかも確認してください。

## Pull Request を送る
Pull Request も同様に歓迎します！   
バグ修正については基本的に問題がなければマージします。   

機能追加の Pull Request については MintWatch のコンセプト的にマージできない場合もあるので、   
実装する前に Issue などを通して事前に相談してください。

また、スペース4つのインデントで、名前付けは基本的にキャメルケースを推奨します。   

ただし、それがReactコンポーネントの場合はパスカルケースにしてください。(Reactの掟に反します)   
これに則って、Reactコンポーネントがメインのファイルのファイル名についてはパスカルケースで書くのも良いでしょう。

## 開発する

> [!IMPORTANT]
MintWatch は、v0.5.0からPNPMに移行しています。   
NPM を使用してビルドしていたユーザーは、PNPM へ移行してビルドを行ってください。

MintWatch のビルドには Node.js と PNPM が必要です。

リポジトリをクローンしたら、`pnpm install` で依存関係のインストールを行ってください。   
3.0.0からは WXT を使っています。そのため、HMRを含む開発サーバーを使えます。

> [!NOTE]
`web-ext.config.js`を見るとわかりますが、WXT においてデフォルトで起動する Runner は無効にしています。  
これは、ランナーが起動するブラウザが資格情報を保持せず、ニコニコ動画に対する拡張機能開発には不向きであると考えたためです。   

> [!WARNING]
オレンジの MintWatch アイコンは、拡張機能が開発サーバーによってビルドされている場合に使用されます。   
その場合、一部のスクリプトは開発サーバーがないと動作しないこともあるので、注意してください。

### Chromium系(Manifest V3)
`pnpm run dev` を実行すると、開発用のサーバーが起動します。    

通常のPM+の使用を妨げないために、ブラウザは別のプロファイルを使用することを推奨します。   

ブラウザの extensions ページを開き、デベロッパーモードを有効にしたら、「パッケージ化されていない拡張機能を読み込む」から、
`.output`フォルダーの`chrome-mv3`フォルダー内を選択してインストールします。

`pnpm run build` を実行すると、拡張機能をビルドします。
同じフォルダーに出力されるので、開発時と同様の手順でインストールできます。

`pnpm run zip` を実行すると、ストア提出用の ZIP ファイルが`.output`フォルダーに作成されます。

### Firefox系(Manifest V2)
`pnpm run dev:firefox` を実行すると、開発用のサーバーが起動します。   

`about:debug`ページを開き、「この Firefox」から、「一時的なアドオンを読み込む…」を選択して、   
`.output/firefox-mv2`フォルダーの`manifest.json`を選択します。   

アドオンは Firefox を閉じると削除されます。   
既に MintWatch がインストールされている場合は、そのバージョンに戻ります。   
> [!WARNING]
Firefoxのバグにより、閉じた際にそのバージョンに戻らず、アドオンが削除されてしまう場合があります。   
その場合は、ストアから再度インストールすると、元のストレージの内容も含めて復元することが出来ます。   
万が一に備えて、ストレージに重要なデータがある場合は、MintWatch の設定からデータをインポートしておくことをおすすめします。  

`pnpm run build:firefox` を実行すると、拡張機能をビルドします。   
同じフォルダーに出力されるので、開発時と同様の手順でインストールできます。   

`pnpm run zip:firefox` を実行すると、ストア提出用の ZIP ファイルが`.output`フォルダーに作成されます。

### Lint と Format
MintWatch は JS/TS のリントに ESLint を、フォーマットに ESLint Stylistic を使用しています。

CSS はリンティングのみです。Stylelint を使用しています。

`pnpm lint:script && pnpm lint:style` を実行すると、ESLint と Stylelint の両方でリンターを実行できます。  
Lefthook が導入されているため、コミット前に自動的に ESLint によるフォーマットが実行されます。

## ディレクトリ構造
まずは WXT の [プロジェクト構造(英語)](https://wxt.dev/guide/essentials/project-structure.html) ページを読んでください。   
これに概ね従っていますが、一部そうではない箇所もあります。

`hooks` フォルダーには、各コンポーネントで使われるフックがあります。

`utils` フォルダーには、各機能に使われる汎用的な関数を含むファイルがいくつかあります。

`types` フォルダーは、ニコニコ動画データに関する型定義を含みます。   
(実際の JSON から変換したため一部不正確かもしれません。特にnullable)

`patches` フォルダーには、NPM パッケージのバグ修正があります。   
現在はdnd-kitのFirefoxで発生する問題を修正するためだけに存在しています。

`components` フォルダーには、各ページで使用する React コンポーネントが格納されています。  
- `pages` 拡張機能のページに使用されるコンポーネント
- `Router` ページのSPAを構築するコンポーネント
- `Global` ヘッダーなどのページ内で共有されるコンポーネント
- `PMWatch` 視聴ページで使用されるコンポーネント
- `ReShogi` ランキングページで使用されるコンポーネント

`watch_injector.ts` は、必要に応じてWXTの `injectScript` を通して実行されるスクリプトです。   
MintWatch のプラグインとして動作します。このファイル内では、一切拡張機能のAPIを使用できません。

## 変更ログについて
[Keep a Changelog](https://keepachangelog.com/en/1.0.0/) に基づき、   
バージョン付けは[Semantic Versioning](https://semver.org/spec/v2.0.0.html) に従います。   

基本的に各ログは「～ました」の形で記述しています。   
変更ログは内部名称を使いすぎず、エンドユーザーが理解できるように記述してください。

## コミットメッセージについて
これといった規則はありませんが、何をしたかを簡潔に書いてください。   
現状以下の通りのヘッダー規則があるので、できれば先頭に入れておいてください。   
(仮段階のため変更される可能性が大いにあります)
- `FEAT:` 新機能の追加、強化
- `CHANGE:` 既存機能の変更、構造の変更やリファクタリング(それが修正を含む場合もCHANGEを優先)
- `FIX:` バグ修正
- `DEPS:` 依存関係の更新や変更
- `DOCS:` 文章の編集や追加(ページ内のリリースノートなども含みます)